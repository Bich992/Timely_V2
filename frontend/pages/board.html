<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Timely ‚Äì Bacheca (Seguiti)</title>
  <link rel="stylesheet" href="/styles/style.css"/>
</head>
<body>
<div class="brand-bg" aria-hidden="true"></div>
<div id="toast-root" aria-live="polite" aria-atomic="true"></div>

<header class="topbar">
  <div class="brand">
    <img src="/assets/logo.svg" class="logo" alt="Timely"/>
    <span>Timely</span>
  </div>
  <nav>
    <a href="/home">Home</a>
    <a href="/board">Bacheca</a>
    <a href="/profile">Profilo</a>
    <a href="/help">Come funziona</a>
    <a href="/roadmap">Roadmap</a>
    <button id="themeToggle" class="chip">üåì</button>
  </nav>
</header>

<main class="container">
  <div class="card">
    <h2>Pulse ‚Äì Post dei profili che segui (in scadenza)</h2>
    <p class="muted">I post dei tuoi seguiti con meno tempo rimanente sono in alto: aiutali a restare vivi! üî•</p>
    <ul id="feed" class="feed"></ul>
  </div>
</main>

<script src="/scripts/app.js"></script>
<script>
  requireAuth(); initThemeToggle(); mountToastRoot(); mountImageModal();

  const username = localStorage.getItem("timely_username");
  const feedEl = document.getElementById("feed");

  function render(list) {
    feedEl.innerHTML = "";
    if (!list || list.length === 0) {
      feedEl.innerHTML = "<li class='muted'>Segui qualcuno per vedere i loro post qui. Vai su un <b>profilo</b> e premi ‚Äú‚ûï Segui‚Äù.</li>";
      return;
    }
    for (const p of list) {
      const secs = p.remainingSeconds || 0;
      const hours = Math.floor(secs / 3600);
      const mins = Math.floor((secs % 3600) / 60);
      const badge = p.certified ? `<span class="badge-cert">‚úî Community Certified</span>` : "";
      const li = document.createElement("li");
      li.className = "post";
      const cid = `c_${p.id}`;
      li.innerHTML = `
        <div class="post-head" style="gap:8px;">
          <div><a class="author-link" href="/user?u=${encodeURIComponent(p.author)}">@${p.author}</a> ${badge}</div>
          <span class="pill">‚è≥ ${hours}h ${mins}m</span>
        </div>
        <p>${escapeHtml(p.content)}</p>
        ${p.imageUrl ? `<img class="post-image clickable" src="${p.imageUrl}" alt="immagine post">` : ""}
        <div class="row">
          ${p.author !== username ? `<button class="chip" data-extend="${p.id}">+1 TIMT ( +6h )</button>` : "<span class='muted'>√à un tuo post</span>"}
          <button class="chip" data-comments="${p.id}">üí¨ Commenti (${p.commentsCount||0})</button>
        </div>
        <div id="${cid}" class="comments"></div>
      `;
      feedEl.appendChild(li);
    }
    bindClickableImages(feedEl);

    feedEl.querySelectorAll("[data-extend]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-extend");
        const res = await api(`/api/posts/${id}/extend`, { method: "POST", body: { username, timt: 1 } });
        if (res?.ok) { showToast('success','Post esteso di +6h'); load(); }
        else { showToast('error', res?.error || "Errore estensione"); }
      });
    });
    feedEl.querySelectorAll("[data-comments]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-comments");
        const container = document.getElementById(`c_${id}`);
        const open = container.classList.contains("open");
        feedEl.querySelectorAll(".comments").forEach(el => el.classList.remove("open"));
        if (!open) {
          container.classList.add("open");
          container.innerHTML = `<div class="muted">Caricamento commenti‚Ä¶</div>`;
          const data = await api(`/api/comments/${id}`);
          container.innerHTML = "";
          for (const c of (data?.comments || [])) {
            const item = document.createElement("div");
            item.className = "comment";
            item.innerHTML = `
              <div class="comment-meta"><a class="author-link" href="/user?u=${encodeURIComponent(c.username)}">@${c.username}</a> ¬∑ ${new Date(c.at).toLocaleString()}</div>
              <div>${escapeHtml(c.text)}</div>
            `;
            container.appendChild(item);
          }
        }
      });
    });
  }

  async function load() {
    const list = await api(`/api/feed/following?username=${encodeURIComponent(username)}`);
    render(list);
  }

  (async function init(){ await load(); setInterval(load, 60000); })();
</script>
</body>
</html>
