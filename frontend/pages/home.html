<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Timely ‚Äì Feed</title>
  <link rel="stylesheet" href="/styles/style.css"/>
</head>
<body>
<div class="brand-bg" aria-hidden="true"></div>
<div id="toast-root" aria-live="polite" aria-atomic="true"></div>

<header class="topbar">
  <div class="brand">
    <img src="/assets/logo.svg" class="logo" alt="Timely"/>
    <span>Timely</span>
  </div>
  <nav>
    <a href="/home">Home</a>
    <a href="/board">Bacheca</a>
    <a href="/profile">Profilo</a>
    <a href="/help">Come funziona</a>
    <a href="/roadmap">Roadmap</a>

    <a href="/pages/challenges.html">Challenges</a>
    <a href="/pages/shop.html">Shop</a>
    <a href="/pages/tutorial.html">Tutorial</a>
    <button id="themeToggle" class="chip">üåì</button>
  </nav>
</header>

<main class="container">
  <section class="balanced">
    <div class="card card--accent">
      <h2>Crea un post (costa 1 TIMT)</h2>
      <p>Saldo TIMT: <strong id="balance">‚Äì</strong></p>
      <form id="postForm">
        <textarea id="content" rows="3" placeholder="Scrivi qualcosa‚Ä¶" required></textarea>
        <div class="row">
          <input type="file" id="postImage" accept="image/png,image/jpeg,image/webp"/>
          <img id="postPreview" class="preview" style="display:none" />
        </div>
        <button type="submit" class="btn btn-primary">Pubblica</button>
      </form>
    </div>

    <div class="card">
      <h2>Feed globale</h2>
      <ul id="feed" class="feed"></ul>
    </div>
  </section>
</main>

<script src="/scripts/app.js"></script>
<script>
  requireAuth();
  initThemeToggle();
  mountToastRoot();
  mountImageModal();

  const username = localStorage.getItem("timely_username");
  const balanceEl = document.getElementById("balance");
  const feedEl = document.getElementById("feed");
  const fileInput = document.getElementById("postImage");
  const preview = document.getElementById("postPreview");
  let savedIds = [];

  fileInput.addEventListener("change", () => {
    const f = fileInput.files?.[0];
    if (!f) { preview.style.display="none"; return; }
    const url = URL.createObjectURL(f);
    preview.src = url; preview.style.display = "block";
  });

  async function refreshBalance() {
    const res = await api(`/api/balance?username=${encodeURIComponent(username)}`);
    balanceEl.textContent = res?.tokens ?? "0";
  }
  async function loadSaved() {
    const res = await api(`/api/saved?username=${encodeURIComponent(username)}`);
    savedIds = res?.savedIds || [];
  }
  function isSaved(id) { return savedIds.includes(id); }

  function renderComments(container, postId) {
    container.innerHTML = `<div class="muted">Caricamento commenti‚Ä¶</div>`;
    (async () => {
      const data = await api(`/api/comments/${postId}`);
      const list = data?.comments || [];
      container.innerHTML = "";
      const wrap = document.createElement("div");
      for (const c of list) {
        const item = document.createElement("div");
        item.className = "comment";
        item.innerHTML = `
          <div class="comment-meta"><a class="author-link" href="/user?u=${encodeURIComponent(c.username)}">@${c.username}</a> ¬∑ ${new Date(c.at).toLocaleString()}</div>
          <div>${escapeHtml(c.text)}</div>
        `;
        wrap.appendChild(item);
      }
      // box nuovo commento
      const box = document.createElement("div");
      box.className = "row";
      box.innerHTML = `
        <input class="comment-box" placeholder="Scrivi un commento‚Ä¶" />
        <button class="chip">Invia</button>
      `;
      const input = box.querySelector(".comment-box");
      const btn = box.querySelector(".chip");
      btn.addEventListener("click", async () => {
        const text = (input.value || "").trim();
        if (!text) return;
        const res = await api(`/api/comment/${postId}`, { method:"POST", body:{ username, text }});
        if (res?.ok) { showToast('success','Commento pubblicato'); renderComments(container, postId); }
        else showToast('error', res?.error || "Errore commento");
      });
      container.appendChild(wrap);
      container.appendChild(box);
    })();
  }

  async function loadFeed() {
    const posts = await api("/api/posts");
    feedEl.innerHTML = "";
    if (!posts || posts.length === 0) {
      feedEl.innerHTML = "<li class='muted'>Nessun post attivo‚Ä¶ pubblica il primo!</li>";
      return;
    }
    for (const p of posts) {
      const secs = p.remainingSeconds || 0;
      const hours = Math.floor(secs / 3600);
      const mins = Math.floor((secs % 3600) / 60);
      const me = p.author === username;
      const saved = isSaved(p.id);
      const badge = p.certified ? `<span class="badge-cert">‚úî Community Certified</span>` : "";
      const li = document.createElement("li");
      li.className = "post";
      const cid = `c_${p.id}`;
      li.innerHTML = `
        <div class="post-head" style="gap:8px;">
          <div><a class="author-link" href="/user?u=${encodeURIComponent(p.author)}">@${p.author}</a> ${badge}</div>
          <span class="pill">‚è≥ ${hours}h ${mins}m</span>
        </div>
        <p>${escapeHtml(p.content)}</p>
        ${p.imageUrl ? `<img class="post-image clickable" src="${p.imageUrl}" alt="immagine post">` : ""}
        <div class="row">
          <button class="chip" data-like="${p.id}">üëç Like (${p.likesCount||0})</button>
          ${me ? "<span class='muted'>√à il tuo post</span>" : `<button class="chip" data-extend="${p.id}">+1 TIMT ( +6h )</button>`}
          <button class="chip" data-save="${p.id}">${saved ? "‚òÖ Salvato" : "‚òÜ Salva"}</button>
          <button class="chip" data-comments="${p.id}">üí¨ Commenti (${p.commentsCount||0})</button>
        </div>
        <div id="${cid}" class="comments"></div>
      `;
      feedEl.appendChild(li);
    }

    bindClickableImages(feedEl);

    // Event handlers
    document.querySelectorAll("[data-extend]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-extend");
        const res = await api(`/api/posts/${id}/extend`, { method: "POST", body: { username, timt: 1 } });
        if (res?.ok) { showToast('success','Post esteso di +6h'); await refreshBalance(); await loadFeed(); }
        else { showToast('error', res?.error || "Errore estensione"); }
      });
    });
    document.querySelectorAll("[data-save]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-save");
        const res = await api(`/api/save/${id}`, { method: "POST", body: { username } });
        if (res?.ok) { savedIds = res.saves || []; showToast('info', (res.saved ? 'Salvato' : 'Rimosso dai preferiti')); await loadFeed(); }
      });
    });
    document.querySelectorAll("[data-like]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-like");
        const res = await api(`/api/like/${id}`, { method: "POST", body: { username } });
        if (res?.ok) { showToast('success','Like aggiunto'); await loadFeed(); }
        else { showToast('error', res?.error || "Errore like"); }
      });
    });
    document.querySelectorAll("[data-comments]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-comments");
        const container = document.getElementById(`c_${id}`);
        const open = container.classList.contains("open");
        document.querySelectorAll(".comments").forEach(el => el.classList.remove("open"));
        if (!open) {
          container.classList.add("open"); renderComments(container, id);
        }
      });
    });
  }

  document.getElementById("postForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const content = document.getElementById("content").value.trim();
    if (!content) return;

    let imageUrl = null;
    const f = fileInput.files?.[0];
    if (f) {
      const fd = new FormData();
      fd.append("image", f); fd.append("username", username);
      const up = await fetch("/api/upload/post-image", { method: "POST", body: fd });
      const j = await up.json();
      if (!j.ok) { showToast('error', j.error || "Errore upload immagine"); return; }
      imageUrl = j.url;
    }
    const res = await api("/api/post", { method: "POST", body: { username, content, imageUrl } });
    if (res?.ok) {
      document.getElementById("content").value = "";
      fileInput.value = ""; preview.style.display = "none";
      showToast('success','Post pubblicato!'); await refreshBalance(); await loadFeed();
    } else showToast('error', res?.error || "Errore pubblicazione");
  });

  (async function init() {
    await refreshBalance(); await loadSaved(); await loadFeed();
    setInterval(loadFeed, 60000);
  })();
</script>
</body>
</html>
